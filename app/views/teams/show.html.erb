<%
  ##  Generic event, not connected to a team?
  ##  Multi-team event?  Lots of possible scenarios ...
  def EventTitle(event, team, opponent)
    title = subtitle = ""
    if event.teamid.blank?
      title = event.description.blank? ? "N/A" : event.description
    elsif event.opponentid.blank? && event.opponents.count != 1
      title = "#{team.formalname} #{event.description}"
    elsif !event.opponentid.blank?
      title = "#{team.formalname} vs #{opponent.name}"
      subtitle = event.description unless event.description.nil?
    elsif !event.description.blank?
      title = event.description unless event.description.nil?
    else
      title = "None"
    end
    return title.strip, subtitle.strip
  end

  ##  Construct the event content based on presence of opponents
  def EventOverviewLI(event)
    venue = Venue.find_by(:id => event.venueid)
    team = event.teamid.blank? ? nil : Team.find_by(:id => event.teamid)
    opponent = event.opponentid.blank? ? nil : Opponent.find_by(:id => event.opponentid)
    status = event.status.blank? || event.status == 'scheduled' ? "" :
      sprintf("<span class=\"event-%s\">%s</span><br />", event.status, event.status.camelize)

    title, subtitle = EventTitle(event, team, opponent)
    if team.nil?
      span = sprintf("<span class=\"ui-li-count-fix ui-li-count\">%s</span>",
        event.eventlocation.camelize[0])
      li = sprintf("<li>%s%s</li>",
        link_to(sprintf("<img src=\"%s\" alt=\"%s\"><h2>%s</h2><p>%s%s at %s</p>",
        image_url("pictograms/svg/Information-Blk.svg"),
        "Information", title, status, event.datetime,
        venue.name).html_safe, event), span)
    elsif event.opponentid.blank?
      span = sprintf("<span class=\"ui-li-count-fix ui-li-count\">%s</span>",
        event.eventlocation.camelize[0])
      li = sprintf("<li>%s%s</li>",
        link_to(sprintf("<img src=\"%s\" alt=\"%s\"><h2>%s</h2><p>%s%s at %s</p>",
        image_url("pictograms/svg/#{team.sport.imageurl}.svg"),
        team.sport.name, team.formalname, status, event.datetime,
        venue.name).html_safe, event), span)
    else
      span = sprintf("<span class=\"ui-li-count-fix ui-li-count\">%s / %s</span>",
        event.eventlocation.camelize[0], opponent.conferenceopponent ? "C" : "N")
      li = sprintf("<li>%s%s</li>",
        link_to(sprintf("<img src=\"%s\" alt=\"%s\"><h2>%s vs %s</h2><p>%s%s at %s</p>",
        image_url("pictograms/svg/#{team.sport.imageurl}.svg"),
        team.sport.name, team.formalname, opponent.name, status, event.datetime,
        venue.name).html_safe, event), span)
     end

     return li.html_safe
  end
%>
<h3 class="ui-bar ui-bar-a ui-corner-none"><%= @team.formalname %></h3>
<figure id="pictogram">
  <%= image_tag("pictograms/svg/#{@team.sport.imageurl}.svg", alt: @team.sport.name, style: "height: 80px;") %>
</figure>
<ul data-role="listview" data-inset="true">
  <% if !@team.url.blank? %> 
    <li><a data-rel="external" href="<%= sprintf("%s", @team.url) %>">Team Web Site<p><%= @team.url %></p></a></li>
  <% end %>
</ul>
  <!--  Team Coaching Staff -->
  <div data-role="collapsible-set" data-inset="true">
      <% if !@team.teampicurl.blank? %> 
        <div data-role="collapsible" data-collapsed="false" data-iconpos="right" data-collapsed-icon="carat-d" data-expanded-icon="carat-u">
        <h3>Team Picture</h3>
          <p class="framed-p center-wrapper"><img class="framed-image" src="<%= @team.teampicurl %>"></p>
        </div>
      <% end %>
      <div data-role="collapsible" data-collapsed="true" data-iconpos="right" data-collapsed-icon="carat-d" data-expanded-icon="carat-u">
        <% events = Event.where(:teamid => @team.id).order(:eventdate, :eventtime) %>
        <h3 class="ui-bar ui-bar-a ui-corner-none">Schedule<span class="ui-li-count-fix ui-li-count"><%= events.count %></span></h3>
        <% if events.count > 0 %>
        <ul data-role="listview" data-inset="true">
          <% events.each do |event| %>
            <%= EventOverviewLI(event) %>
          <% end %>
        </ul>
        <% else %>
          <p>No events scheduled.</p>
        <% end %>
      </div>
      <div data-role="collapsible" data-collapsed="true" data-iconpos="right" data-collapsed-icon="carat-d" data-expanded-icon="carat-u">
        <h3 class="ui-bar ui-bar-a ui-corner-none">Coaching Staff<span class="ui-li-count-fix ui-li-count"><%= @team.coaches.count %></span></h3>
        <% if @team.coaches.count > 0 %>
        <ul data-role="listview" data-inset="false" data-filter="false" data-mini="false">
          <% coaches = @team.coaches.sort_by { |c| [ c.lastname, c.firstname ] } %>
          <% coaches.each do |c| %>
            <% hc = CoachesTeam.find_by(:coach_id => c.id, :team_id => @team.id) %>
            <li><%= link_to(c.lastcommafirst, c) %><span class="ui-li-aside"><%= hc.headcoach ? "Head Coach" : "" %></span></li>
          <% end %>
        </ul>
        <% else %>
        <p>No coaches currently on staff.</p>
        <% end %>
      </div>
    <!--</div>-->
  <!--  Team Athlete Roster -->
    <!--<div data-role="collapsible-set" data-inset="true" data-mini="false">-->
      <div data-role="collapsible" data-collapsed="true" data-iconpos="right" data-collapsed-icon="carat-d" data-expanded-icon="carat-u">
        <h3 class="ui-bar ui-bar-a ui-corner-none">Roster by Name<span class="ui-li-count-fix ui-li-count"><%= @team.athletes.count %></span></h3>
        <% if @team.athletes.count > 0 %>
        <ul data-role="listview" data-inset="false" data-filter="true" data-autodividers="true" data-count-theme="b">
          <% @athletes.each do |a| %>
            <% notes = a.gradyear2class %>
            <% if !a.position.blank? %>
                <% notes = sprintf("%s%s%s", notes, notes.blank? ? "" : " / ", a.position) %>
            <% end %>
            <% if a.captain %>
              <% notes = sprintf("%s%s", notes, notes.blank? ? "Captain" : " / Captain") %>
            <% end %>
<% logger.info(a.to_yaml) %>
            <li><%= link_to(sprintf("%s<p>%s</p>", a.lastcommafirst, notes).html_safe, send(:athlete_path, a)) %><% if !a.jerseynumber.blank? %><span class="ui-li-count-fix ui-li-count">#<%= a.jerseynumber %></span><% end %></li>
          <% end %>
        </ul>
        <% else %>
        <p>No athletes currently on roster.</p>
        <% end %>
      </div>
      <!--  /Team Athlete Roster -->
      <!--  Team Athlete Roster by jersey number -->
      <% if @jerseycount > 0 %>
        <div data-role="collapsible" data-collapsed="true" data-iconpos="right" data-collapsed-icon="carat-d" data-expanded-icon="carat-u">
          <h3 class="ui-bar ui-bar-a ui-corner-none">Roster by Jersey Number<span class="ui-li-count-fix ui-li-count"><%= @team.athletes.count %></span></h3>
          <ul data-role="listview" data-inset="false" data-filter="false" data-autodividers="false" data-count-theme="b">
            <% @athletes = @athletes.sort_by { |a| [ a.jerseynumber.to_i, a.lastname, a.firstname ] } %>
            <% @athletes.each do |a| %>
              <% notes = a.gradyear2class %>
              <% if !a.position.blank? %>
                <% notes = sprintf("%s%s%s", notes, notes.blank? ? "" : " / ", a.position) %>
              <% end %>
              <% if a.captain %>
                <% notes = sprintf("%s%s", notes, notes.blank? ? "Captain" : " / Captain") %>
              <% end %>
              <li><%= link_to(sprintf("%s<p>%s</p>", a.lastcommafirst, notes).html_safe, send(:athlete_path, a)) %><% if !a.jerseynumber.blank? %><span class="ui-li-count-fix ui-li-count">#<%= a.jerseynumber %></span><% end %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
    <!--  /Team Athlete Roster by jersey number -->

    <!--<div data-role="collapsible-set" data-inset="true" data-mini="false">-->
<% if Settings.Twitter.Enabled == "Yes" && !@team.twitter.blank? %>
  <% @TwitterClient.user(@team.twitter.delete("@")) %>
  <% @tweets = @TwitterClient.user_timeline(@team.twitter.delete("@"))[0..2] %>
      <div data-role="collapsible" data-collapsed="false" data-iconpos="right" data-collapsed-icon="carat-d" data-expanded-icon="carat-u">
        <h3 class="ui-bar ui-bar-a ui-corner-none"><%= @team.formalname %> on Twitter</span></h3>
    <% @tweets.each do |tweet| %>
      <div class="ui-body ui-body-a" data-mini="true">
      <%= link_to(sprintf("<h4>@%s</h4><p>%s</p>", tweet.user.screen_name, auto_link_with_json(tweet.text, tweet.to_hash[:entities])).html_safe, "https://www.twitter.com/#{tweet.user.screen_name}") %>
      </div>
    <% end %>

      </div>
    </div>
<% end %>


<!--  Team Twitter Feed -->
<% if 0 == 1 %>
<% if !@team.twitter.blank? %>
  <% @TwitterClient.user(@team.twitter.delete("@")) %>
  <% @tweets = @TwitterClient.user_timeline(@team.twitter.delete("@"))[0..2] %>
  <ul data-role="listview" data-inset="true">
    <li data-role="list-divider"><%= @team.formalname %> on Twitter</li>
    <% @tweets.each do |tweet| %>
      <li><%= link_to(sprintf("@%s<p>%s</p>", tweet.user.screen_name, tweet.text).html_safe, "https://www.twitter.com/#{tweet.user.screen_name}") %></li>
      <li><%= link_to(sprintf("@%s<p>%s</p>", tweet.user.screen_name, auto_link_with_json(tweet.text, tweet.to_hash[:entities])).html_safe, "https://www.twitter.com/#{tweet.user.screen_name}") %></li>
    <% end %>
  </ul>
<% end %>
<% end %>

<% if 0 == 1 %>
<% if !@team.twitter.blank? %>
<div data-role="content">
  <% @TwitterClient.user(@team.twitter.delete("@")) %>
  <% @tweets = @TwitterClient.user_timeline(@team.twitter.delete("@"))[0..2] %>
  <div class="ui-corner-all custom-corners" data-inset="true">
    <div class="ui-bar ui-bar-a" data-mini="true">
      <h3><%= @team.formalname %> on Twitter</h3>
    </div>
    <% @tweets.each do |tweet| %>
      <div class="ui-body ui-body-a" data-mini="true">
      <%= link_to(sprintf("<h4>@%s</h4><p>%s</p>", tweet.user.screen_name, auto_link_with_json(tweet.text, tweet.to_hash[:entities])).html_safe, "https://www.twitter.com/#{tweet.user.screen_name}") %>
      </div>
    <% end %>
  </div>
</div>
<% end %>
<% end %>

<div data-role="controlgroup" data-type="horizontal" data-mini="true">
  <a data-icon="back" data-role="button" class="ui-corner-all" data-rel="back">Back</a>
  <%= link_to 'Back to Teams', teams_path, :'data-icon' => "back", :'data-role' => "button", :'class' => "ui-corner-all" %>
</div>
